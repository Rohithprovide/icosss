<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Data Collection App{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Dancing Script -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1050;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Autocomplete JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const dropdown = document.getElementById('autocomplete-dropdown');
            const searchContainer = document.querySelector('.search-container');
            let currentFocus = -1;
            let debounceTimeout;
            
            if (!searchInput || !dropdown) return;
            
            // Handle input events
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(debounceTimeout);
                
                if (query.length === 0) {
                    hideDropdown();
                    return;
                }
                
                debounceTimeout = setTimeout(() => {
                    fetchSuggestions(query);
                }, 200);
            });
            
            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActive(items);
                } else if (e.key === 'Enter') {
                    if (currentFocus > -1 && items[currentFocus]) {
                        e.preventDefault();
                        selectSuggestion(items[currentFocus].textContent);
                    }
                } else if (e.key === 'Escape') {
                    hideDropdown();
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchContainer.contains(e.target)) {
                    hideDropdown();
                }
            });
            
            function fetchSuggestions(query) {
                console.log('Fetching suggestions for:', query);
                const script = document.createElement('script');
                const callbackName = 'ddgCallback_' + Math.random().toString(36).substr(2, 9);
                
                // Set up callback
                window[callbackName] = function(data) {
                    console.log('DuckDuckGo response:', data);
                    if (data && Array.isArray(data) && data.length > 1) {
                        showSuggestions(data[1]);
                    } else {
                        showSuggestions([]);
                    }
                    cleanup();
                };
                
                function cleanup() {
                    try {
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                    } catch(e) {
                        console.log('Cleanup error:', e);
                    }
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }
                
                // Set up error handling
                script.onerror = function() {
                    console.log('Script load error');
                    cleanup();
                };
                
                // Set timeout
                const timeout = setTimeout(() => {
                    console.log('Request timeout');
                    cleanup();
                }, 5000);
                
                // Override cleanup to clear timeout
                const originalCleanup = cleanup;
                cleanup = function() {
                    clearTimeout(timeout);
                    originalCleanup();
                };
                
                // Make the request
                script.src = `https://duckduckgo.com/ac/?q=${encodeURIComponent(query)}&callback=${callbackName}`;
                document.head.appendChild(script);
                
                console.log('Script added:', script.src);
            }
            
            function showSuggestions(suggestions) {
                console.log('Showing suggestions:', suggestions);
                dropdown.innerHTML = '';
                currentFocus = -1;
                
                if (!suggestions || suggestions.length === 0) {
                    console.log('No suggestions to show');
                    hideDropdown();
                    return;
                }
                
                suggestions.slice(0, 8).forEach(function(suggestion) {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = suggestion;
                    
                    item.addEventListener('click', function() {
                        selectSuggestion(suggestion);
                    });
                    
                    dropdown.appendChild(item);
                });
                
                searchContainer.classList.add('has-suggestions');
                dropdown.classList.add('show');
                console.log('Dropdown should be visible now');
            }
            
            function hideDropdown() {
                dropdown.classList.remove('show');
                searchContainer.classList.remove('has-suggestions');
                currentFocus = -1;
            }
            
            function selectSuggestion(suggestion) {
                searchInput.value = suggestion;
                hideDropdown();
                searchInput.focus();
            }
            
            function setActive(items) {
                items.forEach(function(item, index) {
                    if (index === currentFocus) {
                        item.classList.add('highlighted');
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
            }
        });
    </script>
</body>
</html>
